name: EZ-Clean-MultiArch-Release

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

env:
  GO_VERSION: '1.21'
  MODULE_NAME: 'EZ-Clean'

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: arm64
            android_abi: arm64-v8a
            toolchain_triple: aarch64-linux-android21
          - goarch: arm
            android_abi: armeabi-v7a
            toolchain_triple: armv7a-linux-androideabi21
          - goarch: amd64
            android_abi: x86_64
            toolchain_triple: x86_64-linux-android21
          - goarch: 386
            android_abi: x86
            toolchain_triple: i686-linux-android21
        variant: [basic, full]
      fail-fast: false
      max-parallel: 8
    
    name: Build ${{ matrix.variant }} for ${{ matrix.android_abi }}
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum
            **/go.sum

      - name: Install Android NDK and build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip zip file jq build-essential
          
          # 下载并安装Android NDK
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          export ANDROID_NDK_HOME=$(pwd)/android-ndk-r25b
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          
          echo "NDK安装完成"

      - name: Initialize Go module if needed
        run: |
          if [ ! -f "go.mod" ]; then
            echo "初始化Go模块..."
            go mod init github.com/${{ github.repository }}
          fi
          go mod tidy

      - name: Locate source files
        id: source_files
        run: |
          if [ -f "source/main.go" ]; then
            echo "MAIN_GO=source/main.go" >> $GITHUB_OUTPUT
            echo "EZ_GO=source/ez.go" >> $GITHUB_OUTPUT
          elif [ -f "main.go" ]; then
            echo "MAIN_GO=main.go" >> $GITHUB_OUTPUT
            echo "EZ_GO=ez.go" >> $GITHUB_OUTPUT
          else
            echo "错误: 未找到Go源文件"
            exit 1
          fi

      - name: Setup build parameters
        id: build_params
        run: |
          echo "BINARY_NAME=EZ-${{ matrix.variant }}-${{ matrix.android_abi }}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=EZ-Clean-${{ matrix.variant }}-${{ matrix.android_abi }}.zip" >> $GITHUB_OUTPUT
          echo "MODULE_DIR=module-${{ matrix.variant }}-${{ matrix.android_abi }}" >> $GITHUB_OUTPUT

      - name: Build Go binary with proper CGO configuration
        run: |
          echo "编译 ${{ matrix.variant }} 版本，架构 ${{ matrix.android_abi }} (GOARCH=${{ matrix.goarch }})"
          
          # 确定要编译的源文件
          if [ "${{ matrix.variant }}" = "basic" ]; then
            SOURCE_FILE="${{ steps.source_files.outputs.MAIN_GO }}"
          else
            SOURCE_FILE="${{ steps.source_files.outputs.EZ_GO }}"
          fi
          
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "警告: $SOURCE_FILE 不存在，跳过编译"
            exit 0
          fi
          
          # 设置Android交叉编译环境
          export GOOS=android
          export GOARCH=${{ matrix.goarch }}
          export CGO_ENABLED=1
          
          # 设置NDK工具链路径
          export CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang"
          export CXX="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang++"
          
          # 设置sysroot和其他必要的环境变量
          export ANDROID_SYSROOT="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          echo "使用编译器: $CC"
          echo "Sysroot: $ANDROID_SYSROOT"
          
          # 验证编译器
          if ! $CC --version > /dev/null 2>&1; then
            echo "❌ 编译器无法执行: $CC"
            echo "尝试修复编译器权限..."
            chmod +x "$CC" || true
            if ! $CC --version > /dev/null 2>&1; then
              echo "❌ 编译器仍然无法执行"
              exit 1
            fi
          fi
          
          echo "✅ 编译器验证通过"
          
          # 方法1: 使用CGO和正确的链接标志
          echo "使用方法1: CGO编译..."
          CGO_CFLAGS="--sysroot=$ANDROID_SYSROOT" \
          CGO_LDFLAGS="--sysroot=$ANDROID_SYSROOT" \
          go build -ldflags="-s -w -linkmode=external -extldflags=-static" -o ${{ steps.build_params.outputs.BINARY_NAME }} "$SOURCE_FILE"
          
          if [ -f "${{ steps.build_params.outputs.BINARY_NAME }}" ]; then
            echo "✅ 方法1成功: CGO编译完成"
            file ${{ steps.build_params.outputs.BINARY_NAME }}
          else
            echo "方法1失败，尝试方法2: 简化CGO编译..."
            
            # 方法2: 简化编译参数
            go build -ldflags="-s -w" -o ${{ steps.build_params.outputs.BINARY_NAME }} "$SOURCE_FILE"
            
            if [ -f "${{ steps.build_params.outputs.BINARY_NAME }}" ]; then
              echo "✅ 方法2成功: 简化CGO编译完成"
              file ${{ steps.build_params.outputs.BINARY_NAME }}
            else
              echo "方法2失败，尝试方法3: 使用gomobile方法..."
              
              # 方法3: 使用类似gomobile的方法
              export CGO_CFLAGS="-I$ANDROID_NDK_HOME/sysroot/usr/include"
              export CGO_LDFLAGS="-L$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/${{ matrix.toolchain_triple }}"
              
              go build -ldflags="-s -w" -o ${{ steps.build_params.outputs.BINARY_NAME }} "$SOURCE_FILE"
              
              if [ -f "${{ steps.build_params.outputs.BINARY_NAME }}" ]; then
                echo "✅ 方法3成功: gomobile风格编译完成"
                file ${{ steps.build_params.outputs.BINARY_NAME }}
              else
                echo "❌ 所有编译方法都失败"
                exit 1
              fi
            fi
          fi

      - name: Update module.prop with arch info
        run: |
          if [ -f "module.prop" ]; then
            cp module.prop module.prop.backup
            echo "architecture=${{ matrix.android_abi }}" >> module.prop
            echo "versionCode=$(( $(date +%s) / 100 ))" >> module.prop
            echo "updateJson=https://github.com/${{ github.repository }}/releases/latest/download/update-${{ matrix.android_abi }}.json" >> module.prop
            echo "更新后的module.prop:"
            cat module.prop
          else
            cat > module.prop << EOF
            id=EZ-Clean
            name=EZ Clean
            version=v1.0.0
            versionCode=$(( $(date +%s) / 100 ))
            author=GitHub Actions
            description=Multi-arch EZ Clean module
            architecture=${{ matrix.android_abi }}
            updateJson=https://github.com/${{ github.repository }}/releases/latest/download/update-${{ matrix.android_abi }}.json
            EOF
          fi

      - name: Prepare module files
        run: |
          mkdir -p ${{ steps.build_params.outputs.MODULE_DIR }}
          
          # 复制通用文件
          [ -d "META-INF" ] && cp -r META-INF/ ${{ steps.build_params.outputs.MODULE_DIR }}/
          [ -f "module.prop" ] && cp module.prop ${{ steps.build_params.outputs.MODULE_DIR }}/
          [ -f "customize.sh" ] && cp customize.sh ${{ steps.build_params.outputs.MODULE_DIR }}/
          [ -f "service.sh" ] && cp service.sh ${{ steps.build_params.outputs.MODULE_DIR }}/
          [ -f "*.conf" ] && cp *.conf ${{ steps.build_params.outputs.MODULE_DIR }}/ 2>/dev/null || true
          [ -f "reload.sh" ] && cp reload.sh ${{ steps.build_params.outputs.MODULE_DIR }}/
          
          # 复制二进制文件并重命名为EZ
          cp ${{ steps.build_params.outputs.BINARY_NAME }} ${{ steps.build_params.outputs.MODULE_DIR }}/EZ
          chmod +x ${{ steps.build_params.outputs.MODULE_DIR }}/EZ
          
          echo "模块文件准备完成"

      - name: Package module
        run: |
          cd ${{ steps.build_params.outputs.MODULE_DIR }}
          zip -r ../${{ steps.build_params.outputs.ZIP_NAME }} .
          cd ..
          echo "打包完成: ${{ steps.build_params.outputs.ZIP_NAME }}"

      - name: Generate arch-specific update.json
        run: |
          TIMESTAMP=$(date +%s)
          cat > update-${{ matrix.android_abi }}.json << EOF
          {
            "version": "v$(date +%Y.%m.%d)",
            "versionCode": $(( TIMESTAMP / 100 )),
            "zipUrl": "https://github.com/${{ github.repository }}/releases/latest/download/${{ steps.build_params.outputs.ZIP_NAME }}",
            "changelog": "https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF_NAME:-latest}",
            "architecture": "${{ matrix.android_abi }}"
          }
          EOF

      - name: Restore original module.prop
        run: |
          [ -f "module.prop.backup" ] && mv module.prop.backup module.prop

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.variant }}-${{ matrix.android_abi }}
          path: |
            ${{ steps.build_params.outputs.ZIP_NAME }}
            update-${{ matrix.android_abi }}.json
          retention-days: 7

  create-release:
    runs-on: ubuntu-latest
    needs: build-multi-arch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      actions: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: '*'
          merge-multiple: true

      - name: Generate unified release notes
        run: |
          cat > RELEASE_NOTES.md << EOF
          # EZ-Clean 多架构版本发布
          
          **构建信息**
          - 发布时间: $(date +'%Y-%m-%d %H:%M:%S')
          - 提交: \`${{ github.sha }}\`
          - 触发方式: ${{ github.event_name }}
          
          ## 支持的CPU架构
          | 架构 | 支持设备 | 推荐选择 |
          |------|----------|----------|
          | **arm64-v8a** | 现代64位ARM设备 | ✅ 优先选择 |
          | **armeabi-v7a** | 旧款32位ARM设备 | 老旧设备备用 |
          | **x86_64** | 64位Intel/AMD设备 | 特定设备 |
          | **x86** | 32位Intel设备 | 特定设备 |
          
          ## 版本说明
          - **基础版**: 核心清理功能，体积更小
          - **完整版**: 扩展功能集，功能全面
          
          ## 文件列表
          $(echo -e "\n")
          $(for file in artifacts/*.zip; do
            if [ -f "$file" ]; then
              SIZE=\$(du -h "$file" | cut -f1)
              echo "  - **\$(basename \$file)** (\$SIZE)"
            fi
          done)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "multi-arch-$(date +%Y%m%d-%H%M%S)"
          name: "EZ-Clean 多架构版本 $(date +'%Y.%m.%d')"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/*.zip
            artifacts/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  workflow-cleanup:
    runs-on: ubuntu-latest
    needs: create-release
    if: always() && needs.create-release.result != 'skipped'
    permissions:
      actions: write
    steps:
      - name: Clean old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          retain_runs: 1
          keep_minimum_runs: 0