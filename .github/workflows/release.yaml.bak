name: Build and Release EZ-Clean Module

on:
  push:
<<<<<<< HEAD
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
=======
    tags: ['v*']
>>>>>>> 92b8c13 (‰øÆÂ§çÂ∑•‰ΩúÊµÅ)
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type'
        required: true
        default: 'basic'
        type: choice
        options:
        - basic
        - multi

env:
  GO_VERSION: '1.21'
<<<<<<< HEAD
  MODULE_NAME: 'EZ-Clean'
  NDK_VERSION: 'r26d'

jobs:
  build-multi-arch:
=======
  NDK_VERSION: 'r26b'

jobs:
  build:
>>>>>>> 92b8c13 (‰øÆÂ§çÂ∑•‰ΩúÊµÅ)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
<<<<<<< HEAD
          - goarch: arm64
            android_abi: arm64-v8a
            toolchain_triple: aarch64-linux-android29
          - goarch: arm
            android_abi: armeabi-v7a
            toolchain_triple: armv7a-linux-androideabi29
          - goarch: amd64
            android_abi: x86_64
            toolchain_triple: x86_64-linux-android29
          - goarch: 386
            android_abi: x86
            toolchain_triple: i686-linux-android29
        variant: [basic, full]
      fail-fast: false

    name: Build ${{ matrix.variant }} for ${{ matrix.android_abi }}
=======
          - arch: arm64
            goarch: arm64
            cc: aarch64-linux-android24-clang
            cxx: aarch64-linux-android24-clang++
          - arch: arm
            goarch: arm
            cc: armv7a-linux-androideabi24-clang
            cxx: armv7a-linux-androideabi24-clang++
          - arch: x86
            goarch: 386
            cc: i686-linux-android24-clang
            cxx: i686-linux-android24-clang++
          - arch: x86_64
            goarch: amd64
            cc: x86_64-linux-android24-clang
            cxx: x86_64-linux-android24-clang++
>>>>>>> 92b8c13 (‰øÆÂ§çÂ∑•‰ΩúÊµÅ)

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: Set up Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
        unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
        echo "NDK_HOME=$PWD/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        echo "$PWD/android-ndk-${{ env.NDK_VERSION }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

<<<<<<< HEAD
      - name: ÂÆâË£ÖÊûÑÂª∫‰æùËµñ
        run: |
          sudo apt-get update
          sudo apt-get install -y zip file

      - name: ÂàùÂßãÂåñ Go Ê®°Âùó
        run: |
          if [ ! -f "go.mod" ]; then
            go mod init github.com/${{ github.repository }}
          fi
          go mod tidy

      - name: ÂÆö‰Ωç Go Ê∫êÊñá‰ª∂
        id: source_files
        run: |
          # Ê£ÄÊü•Âü∫Á°ÄÁâàÊ∫êÊñá‰ª∂
          if [ -f "source/main.go" ]; then
            MAIN_GO="source/main.go"
          elif [ -f "main.go" ]; then
            MAIN_GO="main.go"
          else
            echo "ÈîôËØØÔºöÊú™ÊâæÂà∞Âü∫Á°ÄÁâà Go Ê∫êÊñá‰ª∂ (main.go)"
            exit 1
          fi
          
          # Ê£ÄÊü•ÂÆåÊï¥ÁâàÊ∫êÊñá‰ª∂
          if [ -f "source/ez.go" ]; then
            EZ_GO="source/ez.go"
          elif [ -f "ez.go" ]; then
            EZ_GO="ez.go"
          else
            echo "ÈîôËØØÔºöÊú™ÊâæÂà∞ÂÆåÊï¥Áâà Go Ê∫êÊñá‰ª∂ (ez.go)"
            exit 1
          fi
          
          echo "MAIN_GO=$MAIN_GO" >> "$GITHUB_OUTPUT"
          echo "EZ_GO=$EZ_GO" >> "$GITHUB_OUTPUT"
          echo "‚úÖ ÊâæÂà∞Ê∫êÊñá‰ª∂: $MAIN_GO (Âü∫Á°ÄÁâà), $EZ_GO (ÂÆåÊï¥Áâà)"

      - name: È¢ÑËÆ°ÁÆóÁâàÊú¨‰ø°ÊÅØ
        id: version_info
        run: |
          VERSION_DATE=$(date +%Y.%m.%d)
          VERSION_CODE=$(( $(date +%s) / 100 ))
          echo "VERSION_DATE=$VERSION_DATE" >> "$GITHUB_OUTPUT"
          echo "VERSION_CODE=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "ÁâàÊú¨‰ø°ÊÅØ: $VERSION_DATE (‰ª£Á†Å: $VERSION_CODE)"

      - name: ËÆæÁΩÆÊûÑÂª∫ÂèÇÊï∞
        id: build_params
        run: |
          ZIP_NAME="EZ-Clean-${{ matrix.variant }}-${{ matrix.android_abi }}.zip"
          MODULE_DIR="module-${{ matrix.variant }}-${{ matrix.android_abi }}"
          BINARY_NAME="EZ-${{ matrix.variant }}-${{ matrix.android_abi }}"
          
          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "MODULE_DIR=$MODULE_DIR" >> "$GITHUB_OUTPUT"
          echo "BINARY_NAME=$BINARY_NAME" >> "$GITHUB_OUTPUT"

      - name: È™åËØÅ NDK ‰∫§ÂèâÁºñËØëÂô®
        run: |
          NDK_PATH="${{ steps.setup-ndk.outputs.NDK_PATH }}"
          COMPILER_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang"
          
          if [ ! -f "$COMPILER_PATH" ]; then
            echo "‚ùå ÁºñËØëÂô®Êú™ÊâæÂà∞: $COMPILER_PATH"
            echo "ÂèØÁî®ÁöÑÁºñËØëÂô®:"
            find "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/" -name "*clang*" | sort
            exit 1
          fi
          
          echo "‚úÖ ÁºñËØëÂô®È™åËØÅÊàêÂäü: $COMPILER_PATH"
          "$COMPILER_PATH" --version | head -1

      - name: ‰ΩøÁî® CGO ‰∫§ÂèâÁºñËØëÂÆâÂçì‰∫åËøõÂà∂Êñá‰ª∂
        env:
          GOOS: android
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ steps.setup-ndk.outputs.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang
        run: |
          set -e
          BINARY_NAME="${{ steps.build_params.outputs.BINARY_NAME }}"
          
          # Ê†πÊçÆÂèò‰ΩìÈÄâÊã©Ê∫êÊñá‰ª∂
          if [ "${{ matrix.variant }}" = "basic" ]; then
            SOURCE_FILE="${{ steps.source_files.outputs.MAIN_GO }}"
            echo "üîß ÁºñËØëÂü∫Á°ÄÁâà: $SOURCE_FILE"
          else
            SOURCE_FILE="${{ steps.source_files.outputs.EZ_GO }}"
            echo "üîß ÁºñËØëÂÆåÊï¥Áâà: $SOURCE_FILE"
          fi
          
          # È™åËØÅÊ∫êÊñá‰ª∂Â≠òÂú®
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "‚ùå Ê∫êÊñá‰ª∂‰∏çÂ≠òÂú®: $SOURCE_FILE"
            exit 1
          fi
          
          echo "üì¶ ÁºñËØëÁõÆÊ†á: $BINARY_NAME"
          go build -trimpath -ldflags="-s -w" -o "$BINARY_NAME" "$SOURCE_FILE"
          
          echo "‚úÖ ÁºñËØëÊàêÂäü"
          file "$BINARY_NAME"
          ls -lh "$BINARY_NAME"

      - name: ÁîüÊàêÊ®°ÂùóÂ±ûÊÄßÊñá‰ª∂
        run: |
          set -e
          MODULE_PROP_FILE="module-${{ matrix.variant }}-${{ matrix.android_abi }}.prop"
          
          cat > "$MODULE_PROP_FILE" << EOF
id=${{ env.MODULE_NAME }}
name=${{ env.MODULE_NAME }}-${{ matrix.variant }}
version=v${{ steps.version_info.outputs.VERSION_DATE }}
versionCode=${{ steps.version_info.outputs.VERSION_CODE }}
author=GitHub Actions
description=Optimized for ${{ matrix.android_abi }} architecture (${{ matrix.variant }} variant)
architecture=${{ matrix.android_abi }}
EOF
          
          echo "ÁîüÊàêÁöÑ module.prop ÂÜÖÂÆπ:"
          cat "$MODULE_PROP_FILE"

      - name: ÂáÜÂ§áÊ®°ÂùóÊñá‰ª∂
        run: |
          set -e
          MODULE_DIR="${{ steps.build_params.outputs.MODULE_DIR }}"
          BINARY_NAME="${{ steps.build_params.outputs.BINARY_NAME }}"
          MODULE_PROP_FILE="module-${{ matrix.variant }}-${{ matrix.android_abi }}.prop"
          
          echo "üìÅ ÂàõÂª∫Ê®°ÂùóÁõÆÂΩï: $MODULE_DIR"
          mkdir -p "$MODULE_DIR"
          
          # Â§çÂà∂ÈÄöÁî®Ê®°ÂùóÊñá‰ª∂ÁöÑÂáΩÊï∞
          copy_if_exists() {
            local src="$1"
            local dest="$2"
            if [ -f "$src" ] || [ -d "$src" ]; then
              echo "üìÑ Â§çÂà∂: $src -> $dest"
              cp -r "$src" "$dest"
            else
              echo "‚ö†Ô∏è  Ë∑≥Ëøá‰∏çÂ≠òÂú®ÁöÑÊñá‰ª∂: $src"
            fi
          }
          
          # Â§çÂà∂ÈÄöÁî®Êñá‰ª∂
          copy_if_exists "META-INF" "$MODULE_DIR/"
          copy_if_exists "customize.sh" "$MODULE_DIR/"
          copy_if_exists "service.sh" "$MODULE_DIR/"
          copy_if_exists "reload.sh" "$MODULE_DIR/"
          copy_if_exists "blacklist.conf" "$MODULE_DIR/"
          copy_if_exists "whitelist.conf" "$MODULE_DIR/"
          copy_if_exists "MT.conf" "$MODULE_DIR/"
          copy_if_exists "config.conf" "$MODULE_DIR/"
          
          # Â§çÂà∂ÁîüÊàêÁöÑÊ®°ÂùóÈÖçÁΩÆÂíå‰∫åËøõÂà∂Êñá‰ª∂
          cp "$MODULE_PROP_FILE" "$MODULE_DIR/module.prop"
          cp "$BINARY_NAME" "$MODULE_DIR/EZ"
          chmod +x "$MODULE_DIR/EZ"
          
          echo "üìã Ê®°ÂùóÊñá‰ª∂ÂàóË°®:"
          ls -la "$MODULE_DIR/"

      - name: ÊâìÂåÖÊ®°Âùó
        run: |
          set -e
          cd "${{ steps.build_params.outputs.MODULE_DIR }}"
          zip -r9 "../${{ steps.build_params.outputs.ZIP_NAME }}" .
          cd ..
          
          echo "‚úÖ ÊâìÂåÖÂÆåÊàê: ${{ steps.build_params.outputs.ZIP_NAME }}"
          ls -lh "${{ steps.build_params.outputs.ZIP_NAME }}"

      - name: È™åËØÅ Zip Êñá‰ª∂
        run: |
          ZIP_FILE="${{ steps.build_params.outputs.ZIP_NAME }}"
          if [ ! -f "$ZIP_FILE" ]; then
            echo "‚ùå Zip Êñá‰ª∂Êú™ÊâæÂà∞: $ZIP_FILE"
            exit 1
          fi
          
          echo "üîç È™åËØÅ Zip Êñá‰ª∂ÂÜÖÂÆπ:"
          if unzip -l "$ZIP_FILE" > /dev/null; then
            echo "‚úÖ Zip Êñá‰ª∂Ê†ºÂºèÊ≠£Á°Æ"
            echo "üìÅ ÂåÖÂê´ÁöÑÊñá‰ª∂:"
            unzip -l "$ZIP_FILE" | head -10
          else
            echo "‚ùå Zip Êñá‰ª∂ÊçüÂùè"
            exit 1
          fi

      - name: Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        if: always()
        run: |
          # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂‰ΩÜ‰øùÁïôÊûÑÂª∫‰∫ßÁâ©
          rm -f module-*.prop
          echo "üßπ ‰∏¥Êó∂Êñá‰ª∂Ê∏ÖÁêÜÂÆåÊàê"

      - name: ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_params.outputs.ZIP_NAME }}
          path: ${{ steps.build_params.outputs.ZIP_NAME }}
          retention-days: 7

  build-summary:
    name: ÊûÑÂª∫ÁªìÊûúÊ±áÊÄª
    runs-on: ubuntu-latest
    needs: build-multi-arch
    if: always()
    outputs:
      build_succeeded: ${{ steps.summary.outputs.build_succeeded }}
      total_built: ${{ steps.summary.outputs.total_built }}
      
    steps:
      - name: ‰∏ãËΩΩÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
          
      - name: ÁîüÊàêÊûÑÂª∫Êä•Âëä
        id: summary
        run: |
          echo "üìä === ÊûÑÂª∫Ê±áÊÄªÊä•Âëä ==="
          
          # ËÆ°ÁÆóÊàêÂäüÊûÑÂª∫ÁöÑÊï∞Èáè
          if [ -d "artifacts" ]; then
            TOTAL_BUILT=$(find artifacts -maxdepth 1 -type f -name "*.zip" | wc -l)
          else
            TOTAL_BUILT=0
          fi
          
          TOTAL_EXPECTED=8
          SUCCESS_RATE=$(( TOTAL_BUILT * 100 / TOTAL_EXPECTED ))
          
          echo "üìà ÊûÑÂª∫ÊàêÂäüÁéá: $SUCCESS_RATE% ($TOTAL_BUILT/$TOTAL_EXPECTED)"
          
          if [ $TOTAL_BUILT -gt 0 ]; then
            echo "‚úÖ ÊàêÂäüÁöÑÊûÑÂª∫:"
            find artifacts -maxdepth 1 -type f -name "*.zip" -printf "  - %f\n" | sort
          fi
          
          # Ê£ÄÊü•Áº∫Â§±ÁöÑÊûÑÂª∫
          echo "üîç Ê£ÄÊü•Áº∫Â§±ÁöÑÊûÑÂª∫..."
          expected_combinations=(
            "basic-arm64-v8a" "basic-armeabi-v7a" "basic-x86_64" "basic-x86"
            "full-arm64-v8a" "full-armeabi-v7a" "full-x86_64" "full-x86"
          )
          
          for combo in "${expected_combinations[@]}"; do
            if ! find artifacts -name "EZ-Clean-$combo.zip" | grep -q .; then
              echo "‚ùå Áº∫Â§±: $combo"
            fi
          done
          
          echo "total_built=$TOTAL_BUILT" >> "$GITHUB_OUTPUT"
          
          if [ $TOTAL_BUILT -eq $TOTAL_EXPECTED ]; then
            echo "build_succeeded=true" >> "$GITHUB_OUTPUT"
            echo "üéâ ÊâÄÊúâÊû∂ÊûÑÊûÑÂª∫ÊàêÂäüÔºÅ"
          else
            echo "build_succeeded=false" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è ÈÉ®ÂàÜÊûÑÂª∫Â§±Ë¥•ÔºåÂ∑≤‰∏≠Ê≠¢ÂèëÂ∏ÉÊµÅÁ®ã"
          fi

  create-release:
    runs-on: ubuntu-latest
    needs: build-summary
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build-summary.outputs.build_succeeded == 'true'
    permissions:
      contents: write
      
    steps:
      - name: ‰∏ãËΩΩÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ÂáÜÂ§áÂèëÂ∏ÉËµÑÊ∫ê
        id: release_assets
        run: |
          set -e
          # ÁßªÂä®ÊâÄÊúâ zip Êñá‰ª∂Âà∞ artifacts Ê†πÁõÆÂΩï
          find artifacts -name "*.zip" -exec mv {} artifacts/ \;
          
          TAG_NAME="android10-${{ steps.version_info.outputs.VERSION_DATE }}"
          RELEASE_NAME="${{ env.MODULE_NAME }} Android 10+ | ${{ steps.version_info.outputs.VERSION_DATE }}"
          
          echo "TAG_NAME=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "RELEASE_NAME=$RELEASE_NAME" >> "$GITHUB_OUTPUT"
          
          # ‰∏∫ÊØè‰∏™Êû∂ÊûÑÁîüÊàê update.json
          for zip_file in artifacts/*.zip; do
            if [ ! -f "$zip_file" ]; then
              continue
            fi
            
            BASENAME=$(basename "$zip_file" .zip)
            ABI=$(echo "$BASENAME" | grep -oE '(arm64-v8a|armeabi-v7a|x86_64|x86)$')
            VARIANT=$(echo "$BASENAME" | grep -oE '(basic|full)')
            
            if [ -n "$ABI" ] && [ -n "$VARIANT" ]; then
              JSON_FILE="artifacts/update-${VARIANT}-${ABI}.json"
              
              cat > "$JSON_FILE" << EOF
{
  "version": "v${{ steps.version_info.outputs.VERSION_DATE }}",
  "versionCode": ${{ steps.version_info.outputs.VERSION_CODE }},
  "zipUrl": "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/$(basename "$zip_file")",
  "changelog": "https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
}
EOF
              echo "ÁîüÊàêÁöÑÊõ¥Êñ∞ÈÖçÁΩÆ: $(basename "$JSON_FILE")"
            fi
          done

          # ÁîüÊàêÂèëÂ∏ÉËØ¥Êòé
          cat > artifacts/RELEASE_NOTES.md << EOF
# ${{ env.MODULE_NAME }} Â§öÊû∂ÊûÑÂèëÂ∏ÉÁâà

**ÊûÑÂª∫ÁâàÊú¨**: v${{ steps.version_info.outputs.VERSION_DATE }}  
**ÁâàÊú¨‰ª£Á†Å**: ${{ steps.version_info.outputs.VERSION_CODE }}  
**Êèê‰∫§ÂìàÂ∏å**: \`${{ github.sha }}\`  
**ÊûÑÂª∫Êó∂Èó¥**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

## ÂÆâË£ÖÊåáÂçó

1. ‰ΩøÁî® CPU-Z Á≠âÂ∑•ÂÖ∑Á°ÆËÆ§ËÆæÂ§áÊû∂ÊûÑ
2. ‰∏ãËΩΩÂØπÂ∫îÁöÑ Zip Êñá‰ª∂
3. ÈÄöËøá Magisk/KernelSU Âà∑ÂÖ•Ê®°Âùó
4. ÈáçÂêØËÆæÂ§á

## Êñá‰ª∂ÂàóË°®

### Âü∫Á°ÄÁâà (Ê†∏ÂøÉÂäüËÉΩ)
| Êû∂ÊûÑ | Êñá‰ª∂Â§ßÂ∞è |
|------|----------|
$(find artifacts -name "EZ-Clean-basic-*.zip" -exec sh -c 'echo "| \`$(basename {} .zip | sed "s/EZ-Clean-basic-//")\` | \`$(du -h {} | cut -f1)\` |"' \;)

### ÂÆåÊï¥Áâà (Êâ©Â±ïÂäüËÉΩ)
| Êû∂ÊûÑ | Êñá‰ª∂Â§ßÂ∞è |
|------|----------|
$(find artifacts -name "EZ-Clean-full-*.zip" -exec sh -c 'echo "| \`$(basename {} .zip | sed "s/EZ-Clean-full-//")\` | \`$(du -h {} | cut -f1)\` |"' \;)

## Êû∂ÊûÑËØ¥Êòé
- **arm64-v8a**: Áé∞‰ª£ 64 ‰Ωç ARM ËÆæÂ§á
- **armeabi-v7a**: ÊóßÊ¨æ 32 ‰Ωç ARM ËÆæÂ§á  
- **x86_64**: 64 ‰Ωç Intel/AMD ËÆæÂ§á
- **x86**: 32 ‰Ωç Intel/AMD ËÆæÂ§á
EOF

      - name: ÂàõÂª∫ GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_assets.outputs.TAG_NAME }}
          name: ${{ steps.release_assets.outputs.RELEASE_NAME }}
          body_path: artifacts/RELEASE_NOTES.md
          files: artifacts/*.zip artifacts/*.json
          draft: false
          prerelease: false

  # ÁßªÈô§ workflow-cleanup ‰ªªÂä°ÔºåÂõ†‰∏∫ÂÆÉÂèØËÉΩÊÑèÂ§ñÂà†Èô§ÂΩìÂâçËøêË°åËÆ∞ÂΩï
  # Â¶ÇÊûúÈúÄË¶ÅÊ∏ÖÁêÜÔºåÂª∫ËÆÆ‰ΩøÁî® GitHub ÁöÑËá™Âä®Ê∏ÖÁêÜÂäüËÉΩÊàñÂçïÁã¨ÁöÑÂ∑•‰ΩúÊµÅ
=======
    - name: Build basic version
      if: github.event.inputs.version_type != 'multi' || github.event.inputs.version_type == 'basic'
      run: |
        export GOOS=android
        export GOARCH=${{ matrix.goarch }}
        export CC=${{ matrix.cc }}
        export CXX=${{ matrix.cxx }}
        export CGO_ENABLED=1
        
        cd source
        go build -ldflags="-s -w" -o ../EZ main.go
        cd ..
        
        mkdir -p build/basic_${{ matrix.arch }}/META-INF/com/google/android
        cp -r META-INF whitelist.conf blacklist.conf MT.conf service.sh customize.sh reload.sh config.conf build/basic_${{ matrix.arch }}/
        cp EZ build/basic_${{ matrix.arch }}/
        
        # Generate module.prop for basic version
        cat > build/basic_${{ matrix.arch }}/module.prop << EOF
        id=EZ-Clean-basic
        name=EZ Clean (Basic)
        version=v${GITHUB_REF#refs/tags/v}
        versionCode=1
        author=EZ-Team
        description=Basic cleaning functionality with system perception
        support=https://github.com/your-repo
        EOF
        
        # Generate update.json
        cat > build/basic_${{ matrix.arch }}/update.json << EOF
        {
          "version": "v${GITHUB_REF#refs/tags/v}",
          "versionCode": 1,
          "zipUrl": "https://github.com/your-username/your-repo/releases/download/v${GITHUB_REF#refs/tags/v}/EZ-Clean-basic-${{ matrix.arch }}.zip",
          "changelog": "https://github.com/your-username/your-repo/releases/tag/v${GITHUB_REF#refs/tags/v}"
        }
        EOF

    - name: Build multi version
      if: github.event.inputs.version_type != 'basic' || github.event.inputs.version_type == 'multi'
      run: |
        export GOOS=android
        export GOARCH=${{ matrix.goarch }}
        export CC=${{ matrix.cc }}
        export CXX=${{ matrix.cxx }}
        export CGO_ENABLED=1
        
        cd source
        go build -ldflags="-s -w" -o ../EZ ez.go
        cd ..
        
        mkdir -p build/multi_${{ matrix.arch }}/META-INF/com/google/android
        cp -r META-INF whitelist.conf blacklist.conf MT.conf service.sh customize.sh reload.sh config.conf build/multi_${{ matrix.arch }}/
        cp EZ build/multi_${{ matrix.arch }}/
        
        # Generate module.prop for multi version
        cat > build/multi_${{ matrix.arch }}/module.prop << EOF
        id=EZ-Clean-multi
        name=EZ Clean (Multi)
        version=v${GITHUB_REF#refs/tags/v}
        versionCode=1
        author=EZ-Team
        description=Advanced cleaning with health reports, metrics and adaptive features
        support=https://github.com/your-repo
        EOF
        
        # Generate update.json
        cat > build/multi_${{ matrix.arch }}/update.json << EOF
        {
          "version": "v${GITHUB_REF#refs/tags/v}",
          "versionCode": 1,
          "zipUrl": "https://github.com/your-username/your-repo/releases/download/v${GITHUB_REF#refs/tags/v}/EZ-Clean-multi-${{ matrix.arch }}.zip",
          "changelog": "https://github.com/your-username/your-repo/releases/tag/v${GITHUB_REF#refs/tags/v}"
        }
        EOF

    - name: Create installation scripts
      run: |
        # Create update-binary for Magisk
        for dir in build/*/; do
          cat > $dir/META-INF/com/google/android/update-binary << 'EOF'
          #!/sbin/sh
          umask 022
          ui_print() { echo "$1"; }
          require_new_magisk() {
            ui_print "*******************************"
            ui_print " EZ-Clean Module Installer "
            ui_print "*******************************"
          }
          require_new_magisk
          ui_print "- Mounting system"
          mount /system 2>/dev/null
          ui_print "- Installing module files"
          mkdir -p $MODPATH
          cp -rf $(dirname $0)/../../* $MODPATH/
          ui_print "- Setting permissions"
          set_perm_recursive $MODPATH/EZ 0 0 0755 0755
          ui_print "- Installation complete"
          EOF
          
          chmod +x $dir/META-INF/com/google/android/update-binary
        done

    - name: Package modules
      run: |
        cd build
        for dir in */; do
          zip -r "${dir%/}.zip" "$dir"
        done
        ls -la *.zip

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ez-clean-modules-${{ matrix.arch }}
        path: build/*.zip
        retention-days: 1

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -name "*.zip" | sort

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.zip
        body: |
          # EZ-Clean Module Release
          
          ## ËØ¥Êòé
          ËØ∑Ê†πÊçÆCPUÊû∂ÊûÑ‰∏ãËΩΩÂØπÂ∫îÁâàÊú¨ÁöÑÊ®°ÂùóÂåÖÔºÅÊîØÊåÅmagiskÂíåkernelsuÂà∑ÂÖ•„ÄÇ
          
          ### ÁâàÊú¨Âå∫Âà´
          - **basic** ‰∏∫Âü∫Á°ÄÊ¨æÔºåÂåÖÂê´ÂäüËÉΩÔºöÂ∏∏ËßÑÊ∏ÖÁêÜ„ÄÅMTËß¶ÂèëÊ∏ÖÁêÜ„ÄÅÁ≥ªÁªüÊÑüÁü•Á≠âÂü∫Á°ÄÂäüËÉΩ„ÄÇ
          - **multi** ‰∏∫È´òÁ∫ßÊ¨æÔºåÂåÖÂê´Âü∫Á°ÄÂäüËÉΩÂíåÁ≥ªÁªüÊÑüÁü•„ÄÅÁ®ãÂ∫èÂÅ•Â∫∑Êä•Âëä„ÄÅÊÄßËÉΩÊåáÊ†á„ÄÅÁ≥ªÁªüËá™ÈÄÇÂ∫îÁ≠âÁâπÊÆäÂäüËÉΩ„ÄÇ
          
          ### ÊîØÊåÅÊû∂ÊûÑ
          - arm64 (Â§ßÂ§öÊï∞Áé∞‰ª£AndroidËÆæÂ§á)
          - arm (ÊóßÊ¨æAndroidËÆæÂ§á)  
          - x86 (AndroidÊ®°ÊãüÂô®„ÄÅIntelËÆæÂ§á)
          - x86_64 (64‰ΩçIntelËÆæÂ§á)
          
          ### ÂÆâË£ÖËØ¥Êòé
          1. ‰∏ãËΩΩÂØπÂ∫îÊû∂ÊûÑÁöÑzipÊñá‰ª∂
          2. Âú®MagiskÊàñKernelSU‰∏≠Âà∑ÂÖ•
          3. ÈáçÂêØËÆæÂ§áÁîüÊïà
>>>>>>> 92b8c13 (‰øÆÂ§çÂ∑•‰ΩúÊµÅ)
