name: EZ-Clean-Android10-CGO-Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  GO_VERSION: '1.21'
  MODULE_NAME: 'EZ-Clean'
  NDK_VERSION: 'r26d'

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: arm64
            android_abi: arm64-v8a
            toolchain_triple: aarch64-linux-android29
          - goarch: arm
            android_abi: armeabi-v7a
            toolchain_triple: armv7a-linux-androideabi29
          - goarch: amd64
            android_abi: x86_64
            toolchain_triple: x86_64-linux-android29
          - goarch: 386
            android_abi: x86
            toolchain_triple: i686-linux-android29
        variant: [basic, full]
      fail-fast: false

    name: Build ${{ matrix.variant }} for ${{ matrix.android_abi }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go çŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: è®¾ç½®å®‰å“ NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: å®‰è£…æž„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y zip file

      - name: åˆå§‹åŒ– Go æ¨¡å—
        run: |
          if [ ! -f "go.mod" ]; then
            go mod init github.com/${{ github.repository }}
          fi
          go mod tidy

      - name: å®šä½ Go æºæ–‡ä»¶
        id: source_files
        run: |
          # æ£€æŸ¥åŸºç¡€ç‰ˆæºæ–‡ä»¶
          if [ -f "source/main.go" ]; then
            MAIN_GO="source/main.go"
          elif [ -f "main.go" ]; then
            MAIN_GO="main.go"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°åŸºç¡€ç‰ˆ Go æºæ–‡ä»¶ (main.go)"
            exit 1
          fi
          
          # æ£€æŸ¥å®Œæ•´ç‰ˆæºæ–‡ä»¶
          if [ -f "source/ez.go" ]; then
            EZ_GO="source/ez.go"
          elif [ -f "ez.go" ]; then
            EZ_GO="ez.go"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å®Œæ•´ç‰ˆ Go æºæ–‡ä»¶ (ez.go)"
            exit 1
          fi
          
          echo "MAIN_GO=$MAIN_GO" >> "$GITHUB_OUTPUT"
          echo "EZ_GO=$EZ_GO" >> "$GITHUB_OUTPUT"
          echo "âœ… æ‰¾åˆ°æºæ–‡ä»¶: $MAIN_GO (åŸºç¡€ç‰ˆ), $EZ_GO (å®Œæ•´ç‰ˆ)"

      - name: é¢„è®¡ç®—ç‰ˆæœ¬ä¿¡æ¯
        id: version_info
        run: |
          VERSION_DATE=$(date +%Y.%m.%d)
          VERSION_CODE=$(( $(date +%s) / 100 ))
          echo "VERSION_DATE=$VERSION_DATE" >> "$GITHUB_OUTPUT"
          echo "VERSION_CODE=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "ç‰ˆæœ¬ä¿¡æ¯: $VERSION_DATE (ä»£ç : $VERSION_CODE)"

      - name: è®¾ç½®æž„å»ºå‚æ•°
        id: build_params
        run: |
          ZIP_NAME="EZ-Clean-${{ matrix.variant }}-${{ matrix.android_abi }}.zip"
          MODULE_DIR="module-${{ matrix.variant }}-${{ matrix.android_abi }}"
          BINARY_NAME="EZ-${{ matrix.variant }}-${{ matrix.android_abi }}"
          
          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "MODULE_DIR=$MODULE_DIR" >> "$GITHUB_OUTPUT"
          echo "BINARY_NAME=$BINARY_NAME" >> "$GITHUB_OUTPUT"

      - name: éªŒè¯ NDK äº¤å‰ç¼–è¯‘å™¨
        run: |
          NDK_PATH="${{ steps.setup-ndk.outputs.NDK_PATH }}"
          COMPILER_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang"
          
          if [ ! -f "$COMPILER_PATH" ]; then
            echo "âŒ ç¼–è¯‘å™¨æœªæ‰¾åˆ°: $COMPILER_PATH"
            echo "å¯ç”¨çš„ç¼–è¯‘å™¨:"
            find "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/" -name "*clang*" | sort
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯æˆåŠŸ: $COMPILER_PATH"
          "$COMPILER_PATH" --version | head -1

      - name: ä½¿ç”¨ CGO äº¤å‰ç¼–è¯‘å®‰å“äºŒè¿›åˆ¶æ–‡ä»¶
        env:
          GOOS: android
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ steps.setup-ndk.outputs.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang
        run: |
          set -e
          BINARY_NAME="${{ steps.build_params.outputs.BINARY_NAME }}"
          
          # æ ¹æ®å˜ä½“é€‰æ‹©æºæ–‡ä»¶
          if [ "${{ matrix.variant }}" = "basic" ]; then
            SOURCE_FILE="${{ steps.source_files.outputs.MAIN_GO }}"
            echo "ðŸ”§ ç¼–è¯‘åŸºç¡€ç‰ˆ: $SOURCE_FILE"
          else
            SOURCE_FILE="${{ steps.source_files.outputs.EZ_GO }}"
            echo "ðŸ”§ ç¼–è¯‘å®Œæ•´ç‰ˆ: $SOURCE_FILE"
          fi
          
          # éªŒè¯æºæ–‡ä»¶å­˜åœ¨
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: $SOURCE_FILE"
            exit 1
          fi
          
          echo "ðŸ“¦ ç¼–è¯‘ç›®æ ‡: $BINARY_NAME"
          go build -trimpath -ldflags="-s -w" -o "$BINARY_NAME" "$SOURCE_FILE"
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          file "$BINARY_NAME"
          ls -lh "$BINARY_NAME"

      - name: ç”Ÿæˆæ¨¡å—å±žæ€§æ–‡ä»¶
        run: |
          set -e
          MODULE_PROP_FILE="module-${{ matrix.variant }}-${{ matrix.android_abi }}.prop"
          
          cat > "$MODULE_PROP_FILE" << EOF
id=${{ env.MODULE_NAME }}
name=${{ env.MODULE_NAME }}-${{ matrix.variant }}
version=v${{ steps.version_info.outputs.VERSION_DATE }}
versionCode=${{ steps.version_info.outputs.VERSION_CODE }}
author=GitHub Actions
description=Optimized for ${{ matrix.android_abi }} architecture (${{ matrix.variant }} variant)
architecture=${{ matrix.android_abi }}
EOF
          
          echo "ç”Ÿæˆçš„ module.prop å†…å®¹:"
          cat "$MODULE_PROP_FILE"

      - name: å‡†å¤‡æ¨¡å—æ–‡ä»¶
        run: |
          set -e
          MODULE_DIR="${{ steps.build_params.outputs.MODULE_DIR }}"
          BINARY_NAME="${{ steps.build_params.outputs.BINARY_NAME }}"
          MODULE_PROP_FILE="module-${{ matrix.variant }}-${{ matrix.android_abi }}.prop"
          
          echo "ðŸ“ åˆ›å»ºæ¨¡å—ç›®å½•: $MODULE_DIR"
          mkdir -p "$MODULE_DIR"
          
          # å¤åˆ¶é€šç”¨æ¨¡å—æ–‡ä»¶çš„å‡½æ•°
          copy_if_exists() {
            local src="$1"
            local dest="$2"
            if [ -f "$src" ] || [ -d "$src" ]; then
              echo "ðŸ“„ å¤åˆ¶: $src -> $dest"
              cp -r "$src" "$dest"
            else
              echo "âš ï¸  è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶: $src"
            fi
          }
          
          # å¤åˆ¶é€šç”¨æ–‡ä»¶
          copy_if_exists "META-INF" "$MODULE_DIR/"
          copy_if_exists "customize.sh" "$MODULE_DIR/"
          copy_if_exists "service.sh" "$MODULE_DIR/"
          copy_if_exists "reload.sh" "$MODULE_DIR/"
          copy_if_exists "blacklist.conf" "$MODULE_DIR/"
          copy_if_exists "whitelist.conf" "$MODULE_DIR/"
          copy_if_exists "MT.conf" "$MODULE_DIR/"
          copy_if_exists "config.conf" "$MODULE_DIR/"
          
          # å¤åˆ¶ç”Ÿæˆçš„æ¨¡å—é…ç½®å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
          cp "$MODULE_PROP_FILE" "$MODULE_DIR/module.prop"
          cp "$BINARY_NAME" "$MODULE_DIR/EZ"
          chmod +x "$MODULE_DIR/EZ"
          
          echo "ðŸ“‹ æ¨¡å—æ–‡ä»¶åˆ—è¡¨:"
          ls -la "$MODULE_DIR/"

      - name: æ‰“åŒ…æ¨¡å—
        run: |
          set -e
          cd "${{ steps.build_params.outputs.MODULE_DIR }}"
          zip -r9 "../${{ steps.build_params.outputs.ZIP_NAME }}" .
          cd ..
          
          echo "âœ… æ‰“åŒ…å®Œæˆ: ${{ steps.build_params.outputs.ZIP_NAME }}"
          ls -lh "${{ steps.build_params.outputs.ZIP_NAME }}"

      - name: éªŒè¯ Zip æ–‡ä»¶
        run: |
          ZIP_FILE="${{ steps.build_params.outputs.ZIP_NAME }}"
          if [ ! -f "$ZIP_FILE" ]; then
            echo "âŒ Zip æ–‡ä»¶æœªæ‰¾åˆ°: $ZIP_FILE"
            exit 1
          fi
          
          echo "ðŸ” éªŒè¯ Zip æ–‡ä»¶å†…å®¹:"
          if unzip -l "$ZIP_FILE" > /dev/null; then
            echo "âœ… Zip æ–‡ä»¶æ ¼å¼æ­£ç¡®"
            echo "ðŸ“ åŒ…å«çš„æ–‡ä»¶:"
            unzip -l "$ZIP_FILE" | head -10
          else
            echo "âŒ Zip æ–‡ä»¶æŸå"
            exit 1
          fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä½†ä¿ç•™æž„å»ºäº§ç‰©
          rm -f module-*.prop
          echo "ðŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_params.outputs.ZIP_NAME }}
          path: ${{ steps.build_params.outputs.ZIP_NAME }}
          retention-days: 7

  build-summary:
    name: æž„å»ºç»“æžœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: build-multi-arch
    if: always()
    outputs:
      build_succeeded: ${{ steps.summary.outputs.build_succeeded }}
      total_built: ${{ steps.summary.outputs.total_built }}
      
    steps:
      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
          
      - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        id: summary
        run: |
          echo "ðŸ“Š === æž„å»ºæ±‡æ€»æŠ¥å‘Š ==="
          
          # è®¡ç®—æˆåŠŸæž„å»ºçš„æ•°é‡
          if [ -d "artifacts" ]; then
            TOTAL_BUILT=$(find artifacts -maxdepth 1 -type f -name "*.zip" | wc -l)
          else
            TOTAL_BUILT=0
          fi
          
          TOTAL_EXPECTED=8
          SUCCESS_RATE=$(( TOTAL_BUILT * 100 / TOTAL_EXPECTED ))
          
          echo "ðŸ“ˆ æž„å»ºæˆåŠŸçŽ‡: $SUCCESS_RATE% ($TOTAL_BUILT/$TOTAL_EXPECTED)"
          
          if [ $TOTAL_BUILT -gt 0 ]; then
            echo "âœ… æˆåŠŸçš„æž„å»º:"
            find artifacts -maxdepth 1 -type f -name "*.zip" -printf "  - %f\n" | sort
          fi
          
          # æ£€æŸ¥ç¼ºå¤±çš„æž„å»º
          echo "ðŸ” æ£€æŸ¥ç¼ºå¤±çš„æž„å»º..."
          expected_combinations=(
            "basic-arm64-v8a" "basic-armeabi-v7a" "basic-x86_64" "basic-x86"
            "full-arm64-v8a" "full-armeabi-v7a" "full-x86_64" "full-x86"
          )
          
          for combo in "${expected_combinations[@]}"; do
            if ! find artifacts -name "EZ-Clean-$combo.zip" | grep -q .; then
              echo "âŒ ç¼ºå¤±: $combo"
            fi
          done
          
          echo "total_built=$TOTAL_BUILT" >> "$GITHUB_OUTPUT"
          
          if [ $TOTAL_BUILT -eq $TOTAL_EXPECTED ]; then
            echo "build_succeeded=true" >> "$GITHUB_OUTPUT"
            echo "ðŸŽ‰ æ‰€æœ‰æž¶æž„æž„å»ºæˆåŠŸï¼"
          else
            echo "build_succeeded=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ éƒ¨åˆ†æž„å»ºå¤±è´¥ï¼Œå·²ä¸­æ­¢å‘å¸ƒæµç¨‹"
          fi

  create-release:
    runs-on: ubuntu-latest
    needs: build-summary
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build-summary.outputs.build_succeeded == 'true'
    permissions:
      contents: write
      
    steps:
      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: å‡†å¤‡å‘å¸ƒèµ„æº
        id: release_assets
        run: |
          set -e
          # ç§»åŠ¨æ‰€æœ‰ zip æ–‡ä»¶åˆ° artifacts æ ¹ç›®å½•
          find artifacts -name "*.zip" -exec mv {} artifacts/ \;
          
          TAG_NAME="android10-${{ steps.version_info.outputs.VERSION_DATE }}"
          RELEASE_NAME="${{ env.MODULE_NAME }} Android 10+ | ${{ steps.version_info.outputs.VERSION_DATE }}"
          
          echo "TAG_NAME=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "RELEASE_NAME=$RELEASE_NAME" >> "$GITHUB_OUTPUT"
          
          # ä¸ºæ¯ä¸ªæž¶æž„ç”Ÿæˆ update.json
          for zip_file in artifacts/*.zip; do
            if [ ! -f "$zip_file" ]; then
              continue
            fi
            
            BASENAME=$(basename "$zip_file" .zip)
            ABI=$(echo "$BASENAME" | grep -oE '(arm64-v8a|armeabi-v7a|x86_64|x86)$')
            VARIANT=$(echo "$BASENAME" | grep -oE '(basic|full)')
            
            if [ -n "$ABI" ] && [ -n "$VARIANT" ]; then
              JSON_FILE="artifacts/update-${VARIANT}-${ABI}.json"
              
              cat > "$JSON_FILE" << EOF
{
  "version": "v${{ steps.version_info.outputs.VERSION_DATE }}",
  "versionCode": ${{ steps.version_info.outputs.VERSION_CODE }},
  "zipUrl": "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/$(basename "$zip_file")",
  "changelog": "https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
}
EOF
              echo "ç”Ÿæˆçš„æ›´æ–°é…ç½®: $(basename "$JSON_FILE")"
            fi
          done

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > artifacts/RELEASE_NOTES.md << EOF
# ${{ env.MODULE_NAME }} å¤šæž¶æž„å‘å¸ƒç‰ˆ

**æž„å»ºç‰ˆæœ¬**: v${{ steps.version_info.outputs.VERSION_DATE }}  
**ç‰ˆæœ¬ä»£ç **: ${{ steps.version_info.outputs.VERSION_CODE }}  
**æäº¤å“ˆå¸Œ**: \`${{ github.sha }}\`  
**æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

## å®‰è£…æŒ‡å—

1. ä½¿ç”¨ CPU-Z ç­‰å·¥å…·ç¡®è®¤è®¾å¤‡æž¶æž„
2. ä¸‹è½½å¯¹åº”çš„ Zip æ–‡ä»¶
3. é€šè¿‡ Magisk/KernelSU åˆ·å…¥æ¨¡å—
4. é‡å¯è®¾å¤‡

## æ–‡ä»¶åˆ—è¡¨

### åŸºç¡€ç‰ˆ (æ ¸å¿ƒåŠŸèƒ½)
| æž¶æž„ | æ–‡ä»¶å¤§å° |
|------|----------|
$(find artifacts -name "EZ-Clean-basic-*.zip" -exec sh -c 'echo "| \`$(basename {} .zip | sed "s/EZ-Clean-basic-//")\` | \`$(du -h {} | cut -f1)\` |"' \;)

### å®Œæ•´ç‰ˆ (æ‰©å±•åŠŸèƒ½)
| æž¶æž„ | æ–‡ä»¶å¤§å° |
|------|----------|
$(find artifacts -name "EZ-Clean-full-*.zip" -exec sh -c 'echo "| \`$(basename {} .zip | sed "s/EZ-Clean-full-//")\` | \`$(du -h {} | cut -f1)\` |"' \;)

## æž¶æž„è¯´æ˜Ž
- **arm64-v8a**: çŽ°ä»£ 64 ä½ ARM è®¾å¤‡
- **armeabi-v7a**: æ—§æ¬¾ 32 ä½ ARM è®¾å¤‡  
- **x86_64**: 64 ä½ Intel/AMD è®¾å¤‡
- **x86**: 32 ä½ Intel/AMD è®¾å¤‡
EOF

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_assets.outputs.TAG_NAME }}
          name: ${{ steps.release_assets.outputs.RELEASE_NAME }}
          body_path: artifacts/RELEASE_NOTES.md
          files: artifacts/*.zip artifacts/*.json
          draft: false
          prerelease: false

  # ç§»é™¤ workflow-cleanup ä»»åŠ¡ï¼Œå› ä¸ºå®ƒå¯èƒ½æ„å¤–åˆ é™¤å½“å‰è¿è¡Œè®°å½•
  # å¦‚æžœéœ€è¦æ¸…ç†ï¼Œå»ºè®®ä½¿ç”¨ GitHub çš„è‡ªåŠ¨æ¸…ç†åŠŸèƒ½æˆ–å•ç‹¬çš„å·¥ä½œæµ