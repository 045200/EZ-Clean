# GitHub Actions å·¥ä½œæµï¼šä¸ºå®‰å“å¹³å°æ„å»ºå¤šæ¶æ„çš„ Go åº”ç”¨
#
# è¿™ä¸ªå·¥ä½œæµå°†è‡ªåŠ¨åŒ–ä»¥ä¸‹æµç¨‹ï¼š
# 1. è®¾ç½®æ„å»ºç¯å¢ƒï¼ŒåŒ…æ‹¬ Go å’Œå®‰å“ NDKã€‚
# 2. ä½¿ç”¨ CGO ä¸ºå››ç§ä¸åŒçš„å®‰å“ ABIï¼ˆarm64-v8a, armeabi-v7a, x86_64, x86ï¼‰
#    ä»¥åŠä¸¤ç§å˜ä½“ï¼ˆbasic, fullï¼‰è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚
# 3. å°†æ¯ä¸ªæ„å»ºç»“æœæ‰“åŒ…æˆå¯åˆ·å†™çš„ Magisk æ¨¡å— Zip åŒ…ã€‚
# 4. è¿è¡Œä¸€ä¸ªæ±‡æ€»ä»»åŠ¡ï¼Œç¡®ä¿å…¨éƒ¨ 8 ä¸ªæ„å»ºéƒ½æˆåŠŸã€‚
# 5. å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ GitHub Releaseã€‚
# 6. Release ä¸­ä¼šåŒ…å«æ‰€æœ‰ 8 ä¸ª Magisk æ¨¡å—ã€ç”¨äºè‡ªåŠ¨æ›´æ–°çš„ update.json æ–‡ä»¶ï¼Œä»¥åŠè¯¦ç»†çš„å‘å¸ƒæ—¥å¿—ã€‚
# 7. è‡ªåŠ¨æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•ï¼Œä¿æŒä»“åº“æ•´æ´ã€‚

name: EZ-Clean-Android10-CGO-Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

env:
  GO_VERSION: '1.21'
  MODULE_NAME: 'EZ-Clean'
  # ä½¿ç”¨è¾ƒæ–°çš„ç¨³å®šç‰ˆ NDK ä»¥è·å¾—æ›´å¥½çš„å·¥å…·é“¾æ”¯æŒ
  NDK_VERSION: 'r26d'

jobs:
  # æ„å»ºæ ¸å¿ƒä»»åŠ¡ï¼Œä½¿ç”¨çŸ©é˜µç­–ç•¥å¹¶è¡Œæ„å»ºæ‰€æœ‰æ¶æ„å’Œå˜ä½“
  build-multi-arch:
    runs-on: ubuntu-latest
    strategy:
      # æ„å»ºçŸ©é˜µå®šä¹‰äº†æ‰€æœ‰éœ€è¦ç¼–è¯‘çš„æ¶æ„å’Œå˜ä½“ç»„åˆ
      # è¿™å°†äº§ç”Ÿ 2 ä¸ªå˜ä½“ * 4 ä¸ªæ¶æ„ = 8 ä¸ªå¹¶è¡Œçš„æ„å»ºä»»åŠ¡
      matrix:
        include:
          - goarch: arm64
            android_abi: arm64-v8a
            toolchain_triple: aarch64-linux-android29
          - goarch: arm
            android_abi: armeabi-v7a
            toolchain_triple: armv7a-linux-androideabi29
          - goarch: amd64
            android_abi: x86_64
            toolchain_triple: x86_64-linux-android29
          - goarch: 386
            android_abi: x86
            toolchain_triple: i686-linux-android29
        variant: [basic, full]
      # fail-fast: false ç¡®ä¿å³ä½¿çŸ©é˜µä¸­æœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œå…¶ä»–ä»»åŠ¡ä¹Ÿä¼šç»§ç»­è¿è¡Œ
      fail-fast: false

    name: Build ${{ matrix.variant }} for ${{ matrix.android_abi }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: è®¾ç½®å®‰å“ NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y zip file

      - name: åˆå§‹åŒ– Go æ¨¡å—
        run: |
          set -e
          # å¦‚æœ go.mod ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–
          if [ ! -f "go.mod" ]; then
            go mod init github.com/${{ github.repository }}
          fi
          go mod tidy

      - name: å®šä½ Go æºæ–‡ä»¶
        id: source_files
        run: |
          if [ -f "source/main.go" ]; then
            echo "MAIN_GO=source/main.go" >> $GITHUB_OUTPUT
            echo "EZ_GO=source/ez.go" >> $GITHUB_OUTPUT
          elif [ -f "main.go" ]; then
            echo "MAIN_GO=main.go" >> $GITHUB_OUTPUT
            echo "EZ_GO=ez.go" >> $GITHUB_OUTPUT
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Go æºæ–‡ä»¶ã€‚"
            exit 1
          fi

      - name: è®¾ç½®æ„å»ºå‚æ•°
        id: build_params
        run: |
          echo "ZIP_NAME=EZ-Clean-${{ matrix.variant }}-${{ matrix.android_abi }}.zip" >> $GITHUB_OUTPUT
          echo "MODULE_DIR=module-${{ matrix.variant }}-${{ matrix.android_abi }}" >> $GITHUB_OUTPUT

      - name: éªŒè¯ NDK äº¤å‰ç¼–è¯‘å™¨æ˜¯å¦å­˜åœ¨
        run: |
          set -e
          COMPILER_PATH="${{ steps.setup-ndk.outputs.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang"
          echo "æ­£åœ¨æ£€æŸ¥ç¼–è¯‘å™¨: $COMPILER_PATH"
          if [ ! -f "$COMPILER_PATH" ]; then
            echo "âŒ ç¼–è¯‘å™¨æœªåœ¨é¢„æœŸè·¯å¾„æ‰¾åˆ°ï¼"
            echo "æ­£åœ¨åˆ—å‡ºå¯ç”¨çš„ç¼–è¯‘å™¨ä»¥ä¾›è°ƒè¯•:"
            find "${{ steps.setup-ndk.outputs.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/" -name "*clang*"
            exit 1
          fi
          echo "âœ… ç¼–è¯‘å™¨å·²æ‰¾åˆ°ã€‚ç‰ˆæœ¬ä¿¡æ¯:"
          "$COMPILER_PATH" --version

      - name: ä½¿ç”¨ CGO äº¤å‰ç¼–è¯‘å®‰å“äºŒè¿›åˆ¶æ–‡ä»¶
        env:
          GOOS: android
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ steps.setup-ndk.outputs.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.toolchain_triple }}-clang
        run: |
          set -e
          BINARY_NAME="EZ-${{ matrix.variant }}-${{ matrix.android_abi }}"
          if [ "${{ matrix.variant }}" = "basic" ]; then
            SOURCE_FILE="${{ steps.source_files.outputs.MAIN_GO }}"
          else
            SOURCE_FILE="${{ steps.source_files.outputs.EZ_GO }}"
          fi
          echo "æ­£åœ¨ç¼–è¯‘æºæ–‡ä»¶: $SOURCE_FILE"
          go build -ldflags="-s -w" -o "$BINARY_NAME" "$SOURCE_FILE"
          echo "âœ… ç¼–è¯‘æˆåŠŸã€‚äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯:"
          file "$BINARY_NAME"
          ls -lh "$BINARY_NAME"

      - name: æ›´æ–°æ¨¡å—å±æ€§æ–‡ä»¶ (module.prop)
        run: |
          set -e
          # å¤‡ä»½åŸå§‹æ–‡ä»¶ï¼Œä»¥ä¾¿ä¹‹åæ¢å¤
          if [ -f "module.prop" ]; then
            cp module.prop module.prop.backup
          fi
          # ä¸ºå½“å‰æ„å»ºç”Ÿæˆç‰¹å®šçš„ module.prop
          cat > module.prop << EOF
          id=${{ env.MODULE_NAME }}
          name=${{ env.MODULE_NAME }}
          version=v$(date +%Y.%m.%d)
          versionCode=$(( $(date +%s) / 100 ))
          author=GitHub Actions
          description=ä¸º ${{ matrix.android_abi }} æ„å»ºçš„å¤šæ¶æ„æ¨¡å—ã€‚
          architecture=${{ matrix.android_abi }}
          EOF

      - name: å‡†å¤‡æ¨¡å—æ–‡ä»¶
        run: |
          set -e
          BINARY_NAME="EZ-${{ matrix.variant }}-${{ matrix.android_abi }}"
          MODULE_DIR="${{ steps.build_params.outputs.MODULE_DIR }}"
          mkdir -p "$MODULE_DIR"
          
          # å¤åˆ¶é€šç”¨æ¨¡å—æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -d "META-INF" ] && cp -r META-INF/ "$MODULE_DIR"/
          [ -f "customize.sh" ] && cp customize.sh "$MODULE_DIR"/
          [ -f "service.sh" ] && cp service.sh "$MODULE_DIR"/
          
          # å¤åˆ¶ç”Ÿæˆçš„ module.prop å’Œç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
          cp module.prop "$MODULE_DIR"/
          cp "$BINARY_NAME" "$MODULE_DIR"/EZ
          chmod +x "$MODULE_DIR"/EZ
          
          echo "æ¨¡å—æ–‡ä»¶å·²å‡†å¤‡å°±ç»ªäº $MODULE_DIR/:"
          ls -la "$MODULE_DIR"/

      - name: æ‰“åŒ…æ¨¡å—ä¸º Zip æ–‡ä»¶
        run: |
          set -e
          cd ${{ steps.build_params.outputs.MODULE_DIR }}
          zip -r ../${{ steps.build_params.outputs.ZIP_NAME }} .
          cd ..
          echo "æ‰“åŒ…å®Œæˆ: ${{ steps.build_params.outputs.ZIP_NAME }}"

      - name: æ¢å¤åŸå§‹ module.prop
        if: always() # æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½æ‰§è¡Œæ­¤æ­¥éª¤
        run: |
          if [ -f "module.prop.backup" ]; then
            mv module.prop.backup module.prop
            echo "åŸå§‹ module.prop å·²æ¢å¤ã€‚"
          fi

      - name: ä¸Šä¼ æ¨¡å—æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_params.outputs.ZIP_NAME }}
          path: ${{ steps.build_params.outputs.ZIP_NAME }}
          retention-days: 7

  # æ„å»ºæ±‡æ€»ä»»åŠ¡ï¼Œä½œä¸ºåˆ›å»º Release ä¹‹å‰çš„â€œå®ˆé—¨å‘˜â€
  build-summary:
    name: æ„å»ºç»“æœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: build-multi-arch # ä¾èµ–äºæ‰€æœ‰æ„å»ºä»»åŠ¡
    if: always() # å³ä½¿æœ‰æ„å»ºå¤±è´¥ä¹Ÿè¿è¡Œï¼Œä»¥ä¾¿æä¾›æ±‡æ€»æŠ¥å‘Š
    outputs:
      build_succeeded: ${{ steps.summary.outputs.build_succeeded }}
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: æ˜¾ç¤ºæ„å»ºæ±‡æ€»æŠ¥å‘Š
        id: summary
        run: |
          set -e
          echo "=== æ„å»ºæ±‡æ€»æŠ¥å‘Š ==="
          TOTAL_EXPECTED=8
          TOTAL_BUILT=$(find artifacts -type f -name "*.zip" | wc -l)
          
          echo "å·²å®Œæˆçš„æ„å»º:"
          find artifacts -type f -name "*.zip" -printf "âœ… %f\n"

          echo "====================="
          echo "æ€»è®¡æ„å»º: $TOTAL_BUILT/$TOTAL_EXPECTED"
          
          if [ $TOTAL_BUILT -ne $TOTAL_EXPECTED ]; then
            echo "build_succeeded=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ éƒ¨åˆ†æ„å»ºå¤±è´¥ã€‚å·²ä¸­æ­¢å‘å¸ƒæµç¨‹ã€‚"
            exit 1
          else
            echo "build_succeeded=true" >> $GITHUB_OUTPUT
            echo "ğŸ‰ æ‰€æœ‰æ„å»ºå‡å·²æˆåŠŸï¼æ­£åœ¨å‡†å¤‡å‘å¸ƒ..."
          fi

  # åˆ›å»º GitHub Release ä»»åŠ¡
  create-release:
    runs-on: ubuntu-latest
    needs: build-summary # ä¾èµ–äºæ±‡æ€»ä»»åŠ¡
    # ä»…å½“æ¨é€åˆ° main åˆ†æ”¯ä¸”æ‰€æœ‰æ„å»ºéƒ½æˆåŠŸæ—¶æ‰è¿è¡Œ
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build-summary.outputs.build_succeeded == 'true'
    permissions:
      contents: write # éœ€è¦æ­¤æƒé™æ¥åˆ›å»º Release å¹¶ä¸Šä¼ äº§ç‰©
      
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: å‡†å¤‡å‘å¸ƒæ‰€éœ€çš„æ–‡ä»¶ (Release Assets)
        id: release_assets
        run: |
          set -e
          # å°†æ‰€æœ‰ zip æ–‡ä»¶ä»å­ç›®å½•ç§»åŠ¨åˆ°é¡¶å±‚ artifacts ç›®å½•
          find artifacts -type f -name "*.zip" -exec mv {} artifacts/ \;

          TAG_NAME="android10-$(date +'%Y.%m.%d-%H%M')"
          RELEASE_NAME="${{ env.MODULE_NAME }} å®‰å“ 10+ | $(date +'%Y.%m.%d')"
          VERSION_CODE=$(( $(date +%s) / 100 ))

          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          
          # ä¸ºæ¯ä¸ªæ¶æ„ç”Ÿæˆ update.json æ–‡ä»¶
          for zip_file in artifacts/*.zip; do
            BASENAME=$(basename "$zip_file" .zip)
            ABI=$(echo "$BASENAME" | sed -E 's/.*-(arm64-v8a|armeabi-v7a|x86_64|x86)$/\1/')
            JSON_FILE="artifacts/update-${ABI}.json"
            cat > "$JSON_FILE" << EOF
            {
              "version": "v$(date +%Y.%m.%d)",
              "versionCode": ${VERSION_CODE},
              "zipUrl": "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/$(basename "$zip_file")",
              "changelog": "https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
            }
EOF
          done

          # ç”Ÿæˆå‘å¸ƒæ—¥å¿— (Release Notes)
          # !! å·²ä¿®å¤æ­¤å¤„çš„ YAML è¯­æ³•é”™è¯¯ !!
          NOTES_FILE="artifacts/RELEASE_NOTES.md"
          {
            echo "# ${{ env.MODULE_NAME }} å¤šæ¶æ„å‘å¸ƒç‰ˆ"
            echo "**æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            echo "**ä»£ç æäº¤**: \`${{ github.sha }}\`"
            echo ""
            echo "æ­¤ç‰ˆæœ¬ä¸ºæ‰€æœ‰ä¸»æµå®‰å“ CPU æ¶æ„æä¾›äº†æ„å»ºã€‚è¯·å®‰è£…ä¸æ‚¨è®¾å¤‡æ¶æ„ç›¸åŒ¹é…çš„æ¨¡å—ã€‚"
            echo ""
            echo "### å®‰è£…æŒ‡å—"
            echo "1. ä½¿ç”¨ç±»ä¼¼ CPU-Z çš„åº”ç”¨æ£€æŸ¥æ‚¨è®¾å¤‡çš„ ABIï¼ˆæ¶æ„ï¼‰ã€‚"
            echo "2. ä»ä¸‹æ–¹çš„é™„ä»¶ä¸­ä¸‹è½½åŒ¹é…çš„ Zip æ–‡ä»¶ã€‚"
            echo "3. é€šè¿‡ Magisk æˆ– KernelSU åˆ·å…¥æ¨¡å—å¹¶é‡å¯ã€‚"
            echo ""
            echo "### æ–‡ä»¶åˆ—è¡¨"
            echo ""
            echo "#### åŸºç¡€ç‰ˆ (æ ¸å¿ƒåŠŸèƒ½)"
            echo "| æ¶æ„ | å¤§å° |"
            echo "| :--- | :--- |"
            find artifacts -name "EZ-Clean-basic-*.zip" -print0 | sort -z | while IFS= read -r -d '' file; do
                SIZE=$(du -h "$file" | cut -f1); ARCH=$(basename "$file" .zip | sed -E 's/.*-(arm64-v8a|armeabi-v7a|x86_64|x86)$/\1/')
                echo "| \`$ARCH\` | \`$SIZE\` |"
            done
            echo ""
            echo "#### å®Œæ•´ç‰ˆ (æ‰©å±•åŠŸèƒ½)"
            echo "| æ¶æ„ | å¤§å° |"
            echo "| :--- | :--- |"
            find artifacts -name "EZ-Clean-full-*.zip" -print0 | sort -z | while IFS= read -r -d '' file; do
                SIZE=$(du -h "$file" | cut -f1); ARCH=$(basename "$file" .zip | sed -E 's/.*-(arm64-v8a|armeabi-v7a|x86_64|x86)$/\1/')
                echo "| \`$ARCH\` | \`$SIZE\` |"
            done
          } > "$NOTES_FILE"

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_assets.outputs.TAG_NAME }}
          name: ${{ steps.release_assets.outputs.RELEASE_NAME }}
          body_path: artifacts/RELEASE_NOTES.md
          files: artifacts/*

  # æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
  workflow-cleanup:
    runs-on: ubuntu-latest
    needs: create-release
    if: always() && github.ref == 'refs/heads/main'
    permissions:
      actions: write # !! æ­¤å¤„æ·»åŠ äº†å¿…éœ€çš„æƒé™ !!
    steps:
      - name: æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0


